# üßÆ FLUX COMPLET : CALCUL DE DEVIS EXPRESS QUOTE

## üìã VUE D'ENSEMBLE

Le calcul de devis Express Quote suit un flux architectural complexe et bien structur√©, depuis la r√©ception de la requ√™te HTTP jusqu'√† la r√©ponse JSON finale. Voici l'analyse compl√®te de chaque √©tape.

---

## üåê PHASE 1 : R√âCEPTION & ROUTAGE

### **Point d'Entr√©e**
```
POST /api/bookings/calculate
```

### **Controller Principal**
```typescript
// src/app/api/bookings/calculate/route.ts
export async function POST(request: NextRequest) {
  const controller = BaseApiController.getInstance(); // Singleton
  controller.logRequest('POST', '/api/bookings/calculate');
}
```

### **Validation des Donn√©es**
```typescript
const { body, error } = await controller.parseRequestBody(request);
const validation = controller.validateRequest(body, ['type', 'data']);
```

**Format attendu :**
```json
{
  "type": "MOVING|PACK|SERVICE",
  "data": {
    "volume": 25,
    "distance": 80,
    "workers": 3,
    "pickupFloor": 3,
    "deliveryFloor": 2,
    "options": {...}
  }
}
```

---

## üéØ PHASE 2 : D√âTERMINATION DU SERVICE

### **Mapping des Types**
```typescript
let serviceType: ServiceType;
switch (body.type.toUpperCase()) {
  case 'MOVING':   serviceType = ServiceType.MOVING;   break;
  case 'PACK':     serviceType = ServiceType.PACK;     break;
  case 'SERVICE':  serviceType = ServiceType.SERVICE;  break;
  default: return error('Type invalide');
}
```

### **Cr√©ation du Contexte**
```typescript
// src/quotation/domain/valueObjects/QuoteContext.ts
const context = new QuoteContext(serviceType);

// Enrichissement selon le type
switch (serviceType) {
  case ServiceType.MOVING:
    context.setValue('volume', body.data.volume);
    context.setValue('distance', body.data.distance);
    context.setValue('workers', body.data.workers);
    break;
  // ... autres types
}
```

---

## üè≠ PHASE 3 : CONSTRUCTION DU CALCULATEUR

### **Builder Pattern**
```typescript
// src/quotation/application/builders/QuoteCalculatorBuilder.ts
const calculator = await QuoteCalculatorBuilder.create(serviceType);
```

### **Requ√™tes BDD Parall√®les**
```typescript
const [movingRules, packRules, serviceRules, configurations] = await Promise.all([
  ruleRepository.findByServiceType(ServiceType.MOVING),     // ~15 r√®gles
  ruleRepository.findByServiceType(ServiceType.PACK),       // ~8 r√®gles  
  ruleRepository.findByServiceType(ServiceType.SERVICE),    // ~5 r√®gles
  getConfigurations()                                        // ~50 configs
]);
```

### **Services Cr√©√©s**
```typescript
const configService = new ConfigurationService(configurations);
const calculator = new QuoteCalculator(configService, movingRules, packRules, serviceRules);
```

---

## ‚ö° PHASE 4 : CALCUL DU DEVIS

### **Point d'Entr√©e Principal**
```typescript
// src/quotation/domain/calculators/MovingQuoteCalculator.ts
const quote = await calculator.calculate(context);
```

### **4.1 Enrichissement du Contexte**
```typescript
const enrichedContext = this.enrichContext(context, serviceType);

// Pour MOVING :
context.setValue('movers', this.calculateMovers(volume));        // 25m¬≥ ‚Üí 5 d√©m√©nageurs
context.setValue('boxes', this.calculateBoxes(volume));          // 25m¬≥ ‚Üí 250 cartons
context.setValue('fuelCost', this.calculateFuelCost(distance));  // 80km ‚Üí 36‚Ç¨
context.setValue('tollCost', this.calculateTollCost(distance));  // 80km ‚Üí 8.4‚Ç¨
```

### **4.2 Calcul du Prix de Base**
```typescript
const basePrice = this.getBasePrice(enrichedContext);

// Pour MOVING :
private getMovingBasePrice(context: QuoteContext): Money {
  const volume = context.getValue<number>('volume');      // 25m¬≥
  const distance = context.getValue<number>('distance');  // 80km
  const fuelCost = context.getValue<number>('fuelCost');  // 36‚Ç¨
  const tollCost = context.getValue<number>('tollCost');  // 8.4‚Ç¨
  
  // Calculs avec DefaultValues centralis√©s
  const volumePrice = volume * DefaultValues.MOVING_BASE_PRICE_PER_M3;     // 25 √ó 10‚Ç¨ = 250‚Ç¨
  const distancePrice = distance * DefaultValues.MOVING_DISTANCE_PRICE_PER_KM; // 80 √ó 1.5‚Ç¨ = 120‚Ç¨
  
  const total = volumePrice + distancePrice + fuelCost + tollCost; // 250 + 120 + 36 + 8.4 = 414.4‚Ç¨
  return new Money(total);
}
```

---

## üéØ PHASE 5 : APPLICATION DES R√àGLES M√âTIER

### **5.1 S√©lection des R√®gles**
```typescript
const rules = this.getRulesForServiceType(serviceType);
// Pour MOVING : 15 r√®gles (weekend, early booking, fragile items, etc.)
```

### **5.2 Moteur de R√®gles**
```typescript
// src/quotation/domain/services/RuleEngine.ts
const ruleEngine = new RuleEngine(rules);
const { finalPrice, discounts } = ruleEngine.execute(enrichedContext, basePrice);
```

### **5.3 Ex√©cution S√©quentielle des R√®gles**

#### **Tri par Priorit√©**
```typescript
// R√®gles en % d'abord, puis montants fixes, tarif minimum en dernier
this.rules.sort((a, b) => {
  if (a.name === 'Tarif minimum') return 1;
  if (b.name === 'Tarif minimum') return -1;
  if (a.isPercentage() && !b.isPercentage()) return -1;
  return 0;
});
```

#### **Application de Chaque R√®gle**
```typescript
for (const rule of this.rules) {
  if (rule.isApplicable(context)) {
    const ruleResult = rule.apply(currentPrice, context);
    
    if (ruleResult.isApplied) {
      finalPrice = ruleResult.newPrice.getAmount();
      
      // Cr√©er un discount pour tra√ßabilit√©
      const discount = new Discount(
        rule.name,
        rule.isPercentage() ? DiscountType.PERCENTAGE : DiscountType.FIXED,
        Math.abs(ruleResult.impact)
      );
      discounts.push(discount);
    }
  }
}
```

### **5.4 Exemple Concret - D√©m√©nagement Weekend**

**Donn√©es :** 25m¬≥, 80km, Samedi
**Prix de base :** 414.4‚Ç¨

#### **R√®gle 1 : Majoration Weekend**
```typescript
// Condition : day === 0 || day === 6 (Dimanche ou Samedi)
// Impact : +15%
if (date.getDay() === 6) { // Samedi
  newPrice = 414.4 √ó 1.15 = 476.56‚Ç¨
  discount = new Discount("Majoration week-end", PERCENTAGE, 15);
}
```

#### **R√®gle 2 : Early Booking** (si applicable)
```typescript
// Condition : diffDays > 30
// Impact : -10%
if (daysDifference > 30) {
  newPrice = 476.56 √ó 0.9 = 428.90‚Ç¨
  discount = new Discount("R√©duction r√©servation anticip√©e", PERCENTAGE, 10);
}
```

#### **R√®gle 3 : Objets Fragiles** (si applicable)
```typescript
// Condition : hasFragileItems === true
// Impact : +8%
if (context.getValue('hasFragileItems')) {
  newPrice = currentPrice √ó 1.08
  discount = new Discount("Majoration objets fragiles", PERCENTAGE, 8);
}
```

#### **R√®gle 4 : Tarif Minimum**
```typescript
// Condition : toujours applicable
// Impact : prix minimum si prix < seuil
const minimumPrice = DefaultValues.MOVING_MINIMUM_PRICE; // Ex: 300‚Ç¨
if (finalPrice < minimumPrice) {
  finalPrice = minimumPrice;
  // Pas de discount cr√©√© pour le tarif minimum
}
```

---

## üèóÔ∏è PHASE 6 : CR√âATION DU DEVIS

### **Objet Quote Final**
```typescript
// src/quotation/domain/valueObjects/Quote.ts
const quote = new Quote(
  basePrice,    // 414.4‚Ç¨ (prix avant r√®gles)
  finalPrice,   // 476.56‚Ç¨ (prix apr√®s r√®gles)
  discounts,    // [Discount("Majoration week-end", PERCENTAGE, 15)]
  serviceType   // ServiceType.MOVING
);
```

### **Propri√©t√©s de l'Objet Quote**
```typescript
class Quote {
  private readonly calculatedAt: Date;
  
  getBasePrice(): Money      // 414.4‚Ç¨
  getTotalPrice(): Money     // 476.56‚Ç¨
  getDiscounts(): Discount[] // Liste des r√©ductions/majorations
  getServiceType(): ServiceType
  getCalculationDate(): Date
}
```

---

## üìä PHASE 7 : CONSTRUCTION DE LA R√âPONSE

### **Calculs TVA et Total**
```typescript
const responseData = {
  success: true,
  price: quote.getTotalPrice().getAmount(),                    // 476.56‚Ç¨
  vat: Math.round(quote.getTotalPrice().getAmount() * 0.2),   // 95.31‚Ç¨ (20%)
  totalWithVat: Math.round(quote.getTotalPrice().getAmount() * 1.2), // 571.87‚Ç¨
  
  quote: {
    basePrice: quote.getBasePrice().getAmount(),              // 414.4‚Ç¨
    totalPrice: quote.getTotalPrice().getAmount(),            // 476.56‚Ç¨
    vatAmount: Math.round(quote.getTotalPrice().getAmount() * 0.2), // 95.31‚Ç¨
    totalWithVat: Math.round(quote.getTotalPrice().getAmount() * 1.2), // 571.87‚Ç¨
    
    discounts: quote.getDiscounts().map(d => ({
      description: d.getDescription(),                         // "Majoration week-end"
      amount: d.getAmount().getAmount(),                       // 62.16‚Ç¨
      type: d.getType()                                        // "PERCENTAGE"
    })),
    
    serviceType: quote.getServiceType()                        // "MOVING"
  },
  
  calculation_type: "builder_calculator"
};
```

### **R√©ponse JSON Finale**
```json
{
  "success": true,
  "price": 476.56,
  "vat": 95.31,
  "totalWithVat": 571.87,
  "quote": {
    "basePrice": 414.4,
    "totalPrice": 476.56,
    "vatAmount": 95.31,
    "totalWithVat": 571.87,
    "discounts": [
      {
        "description": "Majoration week-end",
        "amount": 62.16,
        "type": "PERCENTAGE"
      }
    ],
    "serviceType": "MOVING"
  },
  "calculation_type": "builder_calculator"
}
```

---

## üîÑ FLUX ALTERNATIF : FALLBACK

### **En Cas d'Erreur**
Si le calculateur principal √©choue, le syst√®me utilise le `FallbackCalculatorService` :

```typescript
// src/quotation/application/services/FallbackCalculatorService.ts
try {
  const quote = await calculator.calculate(context);
} catch (error) {
  console.log("‚ùå Erreur calculateur principal, utilisation du fallback");
  const fallbackService = FallbackCalculatorService.getInstance();
  const fallbackResult = fallbackService.calculateMovingFallback(params);
  return fallbackResult;
}
```

---

## üìà M√âTRIQUES DE PERFORMANCE

### **Temps d'Ex√©cution Typique**
- **Requ√™tes BDD parall√®les :** ~50-100ms
- **Cr√©ation du calculateur :** ~10-20ms
- **Enrichissement contexte :** ~5-10ms
- **Calcul prix de base :** ~1-2ms
- **Application des r√®gles :** ~5-15ms
- **Construction r√©ponse :** ~1-2ms

**Total moyen :** ~70-150ms

### **Ressources Utilis√©es**
- **R√®gles m√©tier :** 15-30 r√®gles selon le service
- **Configurations :** 50+ valeurs centralis√©es
- **Calculs :** 10-20 op√©rations math√©matiques
- **Objets cr√©√©s :** ~20-30 instances

---

## üõ°Ô∏è GESTION D'ERREURS

### **Points de Contr√¥le**
1. **Validation des donn√©es d'entr√©e**
2. **Validation du contexte**
3. **V√©rification des r√®gles**
4. **Validation des prix**
5. **Fallback automatique**

### **Types d'Erreurs G√©r√©es**
- `ValidationError` : Donn√©es invalides
- `QuoteCalculationError` : Erreur de calcul
- `DatabaseError` : Probl√®me BDD
- `ConfigurationError` : Configuration manquante

---

## üéØ POINTS CL√âS D'ARCHITECTURE

### **Design Patterns Utilis√©s**
- **Builder Pattern** : Construction du calculateur
- **Strategy Pattern** : Diff√©rents types de calculs
- **Singleton Pattern** : Services partag√©s
- **Factory Pattern** : Cr√©ation des objets m√©tier

### **Principes SOLID Respect√©s**
- **SRP** : Chaque classe a une responsabilit√© unique
- **OCP** : Extensible sans modification (nouveaux services)
- **DIP** : D√©pendances vers des abstractions

### **Avantages de l'Architecture**
- ‚úÖ **Extensible** : Facile d'ajouter de nouveaux services
- ‚úÖ **Maintenable** : Code modulaire et test√©
- ‚úÖ **Performant** : Requ√™tes optimis√©es et cache
- ‚úÖ **Fiable** : Fallback et gestion d'erreurs
- ‚úÖ **Tra√ßable** : Logs d√©taill√©s √† chaque √©tape

---

*Flux document√© le : $(date)*  
*Architecture Express Quote v2.0*  
*Statut : ‚úÖ PRODUCTION READY*" 


SCHEMA DU FLUX:

graph TD
    A[üåê POST /api/bookings/calculate] --> B[üì¶ BaseApiController.getInstance]
    B --> C[üîç parseRequestBody]
    C --> D[‚úÖ validateRequest]
    D --> E{üéØ Type de Service?}
    
    E -->|MOVING| F[üìã ServiceType.MOVING]
    E -->|PACK| G[üìã ServiceType.PACK]
    E -->|SERVICE| H[üìã ServiceType.SERVICE]
    
    F --> I[üèóÔ∏è new QuoteContext<br/>ServiceType.MOVING]
    G --> I
    H --> I
    
    I --> J[üìù Enrichissement Contexte]
    J --> J1[setValue volume, distance, workers]
    J1 --> J2[setValue pickupFloor, deliveryFloor]
    J2 --> J3[setValue constraints, options]
    J3 --> K[üîç context.validate]
    
    K --> L[üè≠ QuoteCalculatorBuilder.create<br/>serviceType]
    
    L --> M[üîÑ Requ√™tes BDD Parall√®les]
    M --> M1[üîç findByServiceType MOVING<br/>‚Üí 15 r√®gles]
    M --> M2[üîç findByServiceType PACK<br/>‚Üí 8 r√®gles]
    M --> M3[üîç findByServiceType SERVICE<br/>‚Üí 5 r√®gles]
    M --> M4[üîç getConfigurations<br/>‚Üí 50+ configs]
    
    M1 --> N[üèóÔ∏è new ConfigurationService]
    M2 --> N
    M3 --> N
    M4 --> N
    
    N --> O[üèóÔ∏è new QuoteCalculator<br/>configService, rules]
    
    O --> P[‚ö° calculator.calculate<br/>context]
    
    P --> Q[üîç D√©terminer ServiceType]
    Q --> R{üéØ Type?}
    
    R -->|MOVING| S[üìä Calcul MOVING]
    R -->|PACK| T[üìä Calcul PACK]
    R -->|SERVICE| U[üìä Calcul SERVICE]
    
    S --> S1[üìê enrichContext<br/>‚Üí calculateMovers]
    S1 --> S2[üìê enrichContext<br/>‚Üí calculateBoxes]
    S2 --> S3[üìê enrichContext<br/>‚Üí calculateFuelCost]
    S3 --> S4[üìê enrichContext<br/>‚Üí calculateTollCost]
    S4 --> V[üí∞ getMovingBasePrice]
    
    T --> T1[üìê enrichContext<br/>‚Üí defaultPrice, workers]
    T1 --> T2[üìê enrichContext<br/>‚Üí duration, distance]
    T2 --> W[üí∞ getPackBasePrice]
    
    U --> U1[üìê enrichContext<br/>‚Üí defaultPrice, workers]
    U1 --> U2[üìê enrichContext<br/>‚Üí duration, constraints]
    U2 --> X[üí∞ getServiceBasePrice]
    
    V --> V1[üßÆ volume √ó MOVING_BASE_PRICE_PER_M3]
    V1 --> V2[üßÆ + distance √ó DISTANCE_PRICE_PER_KM]
    V2 --> V3[üßÆ + fuelCost + tollCost]
    V3 --> Y[üí∞ basePrice]
    
    W --> W1[üßÆ Calcul prix pack<br/>selon workers/duration]
    W1 --> Y
    
    X --> X1[üßÆ Calcul prix service<br/>selon workers/duration]
    X1 --> Y
    
    Y --> Z[üéØ getRulesForServiceType]
    Z --> Z1{üéØ ServiceType?}
    
    Z1 -->|MOVING| AA[üìã movingRules<br/>15 r√®gles]
    Z1 -->|PACK| BB[üìã packRules<br/>8 r√®gles]
    Z1 -->|SERVICE| CC[üìã serviceRules<br/>5 r√®gles]
    
    AA --> DD[üîß new RuleEngine<br/>rules]
    BB --> DD
    CC --> DD
    
    DD --> EE[‚ö° ruleEngine.execute<br/>context, basePrice]
    
    EE --> FF[üîÑ Tri des r√®gles par priorit√©]
    FF --> GG[üîÑ Pour chaque r√®gle]
    
    GG --> HH{üîç rule.isApplicable<br/>context?}
    
    HH -->|‚ùå Non| II[‚û°Ô∏è R√®gle suivante]
    HH -->|‚úÖ Oui| JJ[‚ö° rule.apply<br/>price, context]
    
    JJ --> KK{üéØ Type de r√®gle?}
    
    KK -->|üí∞ Tarif minimum| LL[üìù Stocker minimumPrice]
    KK -->|üìà Pourcentage| MM[üßÆ newPrice = price √ó 1 + %/100]
    KK -->|üíµ Montant fixe| NN[üßÆ newPrice = price + montant]
    
    LL --> II
    MM --> OO[üìù Cr√©er Discount<br/>PERCENTAGE]
    NN --> PP[üìù Cr√©er Discount<br/>FIXED]
    
    OO --> QQ[üìã Ajouter √† discounts]
    PP --> QQ
    QQ --> II
    
    II --> RR{üîÑ Autres r√®gles?}
    RR -->|‚úÖ Oui| GG
    RR -->|‚ùå Non| SS[üîç V√©rifier prix minimum]
    
    SS --> TT{üí∞ finalPrice < minimumPrice?}
    TT -->|‚úÖ Oui| UU[üìù finalPrice = minimumPrice]
    TT -->|‚ùå Non| VV[‚úÖ Prix final valid√©]
    UU --> VV
    
    VV --> WW[üèóÔ∏è new Quote<br/>basePrice, finalPrice, discounts, serviceType]
    
    WW --> XX[üìä Construire r√©ponse API]
    XX --> XX1[üí∞ price = quote.getTotalPrice]
    XX1 --> XX2[üßÆ vat = price √ó 0.2]
    XX2 --> XX3[üßÆ totalWithVat = price √ó 1.2]
    XX3 --> XX4[üìã Mapper discounts]
    XX4 --> YY[‚úÖ successResponse]
    
    YY --> ZZ[üì§ Retour JSON]
    
    style A fill:#e1f5fe
    style ZZ fill:#e8f5e8
    style DD fill:#fff3e0
    style EE fill:#fff3e0
    style WW fill:#f3e5f5

    SHEMA DU FLUX (exemple):

    graph TD
    A[üåê POST /api/bookings/calculate] --> B[üì¶ BaseApiController.getInstance]
    B --> C[üîç parseRequestBody]
    C --> D[‚úÖ validateRequest]
    D --> E{üéØ Type de Service?}
    
    E -->|MOVING| F[üìã ServiceType.MOVING]
    E -->|PACK| G[üìã ServiceType.PACK]
    E -->|SERVICE| H[üìã ServiceType.SERVICE]
    
    F --> I[üèóÔ∏è new QuoteContext<br/>ServiceType.MOVING]
    G --> I
    H --> I
    
    I --> J[üìù Enrichissement Contexte]
    J --> J1[setValue volume, distance, workers]
    J1 --> J2[setValue pickupFloor, deliveryFloor]
    J2 --> J3[setValue constraints, options]
    J3 --> K[üîç context.validate]
    
    K --> L[üè≠ QuoteCalculatorBuilder.create<br/>serviceType]
    
    L --> M[üîÑ Requ√™tes BDD Parall√®les]
    M --> M1[üîç findByServiceType MOVING<br/>‚Üí 15 r√®gles]
    M --> M2[üîç findByServiceType PACK<br/>‚Üí 8 r√®gles]
    M --> M3[üîç findByServiceType SERVICE<br/>‚Üí 5 r√®gles]
    M --> M4[üîç getConfigurations<br/>‚Üí 50+ configs]
    
    M1 --> N[üèóÔ∏è new ConfigurationService]
    M2 --> N
    M3 --> N
    M4 --> N
    
    N --> O[üèóÔ∏è new QuoteCalculator<br/>configService, rules]
    
    O --> P[‚ö° calculator.calculate<br/>context]
    
    P --> Q[üîç D√©terminer ServiceType]
    Q --> R{üéØ Type?}
    
    R -->|MOVING| S[üìä Calcul MOVING]
    R -->|PACK| T[üìä Calcul PACK]
    R -->|SERVICE| U[üìä Calcul SERVICE]
    
    S --> S1[üìê enrichContext<br/>‚Üí calculateMovers]
    S1 --> S2[üìê enrichContext<br/>‚Üí calculateBoxes]
    S2 --> S3[üìê enrichContext<br/>‚Üí calculateFuelCost]
    S3 --> S4[üìê enrichContext<br/>‚Üí calculateTollCost]
    S4 --> V[üí∞ getMovingBasePrice]
    
    T --> T1[üìê enrichContext<br/>‚Üí defaultPrice, workers]
    T1 --> T2[üìê enrichContext<br/>‚Üí duration, distance]
    T2 --> W[üí∞ getPackBasePrice]
    
    U --> U1[üìê enrichContext<br/>‚Üí defaultPrice, workers]
    U1 --> U2[üìê enrichContext<br/>‚Üí duration, constraints]
    U2 --> X[üí∞ getServiceBasePrice]
    
    V --> V1[üßÆ volume √ó MOVING_BASE_PRICE_PER_M3]
    V1 --> V2[üßÆ + distance √ó DISTANCE_PRICE_PER_KM]
    V2 --> V3[üßÆ + fuelCost + tollCost]
    V3 --> Y[üí∞ basePrice]
    
    W --> W1[üßÆ Calcul prix pack<br/>selon workers/duration]
    W1 --> Y
    
    X --> X1[üßÆ Calcul prix service<br/>selon workers/duration]
    X1 --> Y
    
    Y --> Z[üéØ getRulesForServiceType]
    Z --> Z1{üéØ ServiceType?}
    
    Z1 -->|MOVING| AA[üìã movingRules<br/>15 r√®gles]
    Z1 -->|PACK| BB[üìã packRules<br/>8 r√®gles]
    Z1 -->|SERVICE| CC[üìã serviceRules<br/>5 r√®gles]
    
    AA --> DD[üîß new RuleEngine<br/>rules]
    BB --> DD
    CC --> DD
    
    DD --> EE[‚ö° ruleEngine.execute<br/>context, basePrice]
    
    EE --> FF[üîÑ Tri des r√®gles par priorit√©]
    FF --> GG[üîÑ Pour chaque r√®gle]
    
    GG --> HH{üîç rule.isApplicable<br/>context?}
    
    HH -->|‚ùå Non| II[‚û°Ô∏è R√®gle suivante]
    HH -->|‚úÖ Oui| JJ[‚ö° rule.apply<br/>price, context]
    
    JJ --> KK{üéØ Type de r√®gle?}
    
    KK -->|üí∞ Tarif minimum| LL[üìù Stocker minimumPrice]
    KK -->|üìà Pourcentage| MM[üßÆ newPrice = price √ó 1 + %/100]
    KK -->|üíµ Montant fixe| NN[üßÆ newPrice = price + montant]
    
    LL --> II
    MM --> OO[üìù Cr√©er Discount<br/>PERCENTAGE]
    NN --> PP[üìù Cr√©er Discount<br/>FIXED]
    
    OO --> QQ[üìã Ajouter √† discounts]
    PP --> QQ
    QQ --> II
    
    II --> RR{üîÑ Autres r√®gles?}
    RR -->|‚úÖ Oui| GG
    RR -->|‚ùå Non| SS[üîç V√©rifier prix minimum]
    
    SS --> TT{üí∞ finalPrice < minimumPrice?}
    TT -->|‚úÖ Oui| UU[üìù finalPrice = minimumPrice]
    TT -->|‚ùå Non| VV[‚úÖ Prix final valid√©]
    UU --> VV
    
    VV --> WW[üèóÔ∏è new Quote<br/>basePrice, finalPrice, discounts, serviceType]
    
    WW --> XX[üìä Construire r√©ponse API]
    XX --> XX1[üí∞ price = quote.getTotalPrice]
    XX1 --> XX2[üßÆ vat = price √ó 0.2]
    XX2 --> XX3[üßÆ totalWithVat = price √ó 1.2]
    XX3 --> XX4[üìã Mapper discounts]
    XX4 --> YY[‚úÖ successResponse]
    
    YY --> ZZ[üì§ Retour JSON]
    
    style A fill:#e1f5fe
    style ZZ fill:#e8f5e8
    style DD fill:#fff3e0
    style EE fill:#fff3e0
    style WW fill:#f3e5f5